# TCP/IP基础（二）

## MTU（最大传输单元）/路径MTU

1. 以太网和IEEE802.3对数据帧的长度都有限制，其中最大值分别是1500和1492字节，将这个限制作为最大传输单元（MTU，Maximum Transmission Unit）
2. 如果IP层有一个数据包要传输，而且数据的长度比链路层还要大，那么IP层就要进行分片（Fragmentation），把数据报分成若干片，这样每一片都小于MTU（分片会降低网络的通信效率）
3. 当网络上的两台主机互相进行通信的时候，两台主机之间要经过很多网络，每个网络的链路层可能有不同的MTU，其中两台通信主机路径中的最小MTU被称为路径MTU

## 以太网帧格式

![](https://i.loli.net/2020/04/22/rzo2RSLKdJDEOTj.png)

- 类型为0800的时候表示是IP数据包，类型为0806表示是ARP协议，类型是8035表示是RARP协议

- IP->MAC 地址解析协议（ARP协议）
- MAC->IP 反向地址解析（RARP协议）

![](https://i.loli.net/2020/04/22/R1EGkSlVPgjbYfC.png)

### 数据从下层到上层传递要做的事

1. 当数据从左边从上往下传输的时候，到了右边链路层，封装成了帧。
2. 这个时候要选择继续向上传递，这个时候与要确定传给网络层还是ARP协议，或者是RARP协议。这两个协议通常归类的链路层，但实际上是介于链路层和ARP之间的协议，但链路层如何决定数据包传送给上层还是两个协议呢？
3. 应该根据以太网帧里的类型来判定，判定了之后将以太网帧头部去掉，这个过程就叫分用或者解分
4. 往上层分送的时候，也要根据IP头部的类型判断，传输到哪里
5. 传送到哪个应用，要根据端口来判断

### 数据从上层到下层封装要做的事

1. 会打上对应层次的头部
2. 应用层的TCP协议到传输层会打上TCP协议头部，
3. TCP是封装成IP报文来传输的，到了网络层会打上IP头部
4. 到了链路层的时候要打上以太网的头部，以太网头部有两个重要的信息
   1. 源MAC地址
   2. 目的MAC地址
      1. 从哪里来？
      2. 对应用层来说要跟对方进行通信，根据逻辑地址IP地址，他并不知道对方的MAC地址，这个时候，以太网帧格式需要MAC地址，这个时候就要将IP地址转换为MAC地址，这个过程称为地址解析。
      3. 但是可能会出现问题，因为我们可能无法将一个IP地址转换为MAC地址，因为对应的MAC地址可能不存在，这个时候就会出现差错
      4. 这个差错我们要通知给源端，这个机制使用的机制就是下面的ICMP协议

## ICMP（IP层的协议）

- ICMP协议用于传递差错信息、时间、回显、网络信息等控制数据
- 工作于IP层/网络层

![](https://i.loli.net/2020/04/22/5GFyjTLYDRePSIA.png)

- 当我们数据进行封装的时候会从上到下将数据封装成IP数据报，但是数据超过了MTU的时候，IP层就会分片，如果我们设置了不分片，这个时候就会造成错误
- 这个错误也通过ICMP来通知，这个时候就会通知第一条写的那些差错信息
- ping 判断对方数据是否可达，就是将数据封装成ICMP协议，来进行实现的

![](https://i.loli.net/2020/04/22/OtX6lncWoL5GS3Z.png)

![](https://i.loli.net/2020/04/22/4GsRQAFaow9cmPt.png)

![](https://i.loli.net/2020/04/22/F5pVcBPL8u6hwmb.png)

## ARP(地址解析协议)

![](https://i.loli.net/2020/04/22/7MjK5ayQNDtSJox.png)

![](https://i.loli.net/2020/04/22/wncvtDr2aYVeHiZ.png)

> 下图是数据在网络传输的过程

![](https://i.loli.net/2020/04/22/BNRp9b5STwL1k8f.png)

1. 应用程序ping会判断发送的是主机名还是ip地址，调用函数gethostbyname( )解析主机B，将主机名转换成一个32位的IP地址，这个过程叫DNS域名解析
2. ping程序向目的IP地址发送一个ICMP的ECHO包
3. 将目的主机的IP地址转换为48位硬件地址，在局域网内发送ARP请求广播，查找主机B的硬件地址
4. 主机B的ARP协议层接收到主机A的ARP请求后，将本机的硬件地址填充到应答包，发送ARP应答到主机A
5. 发送ICMP数据到主机B
6. 主机B收到主机A的ICMP包，发送响应包
7. 主机A接受主机B的IMP的响应包

## RARP（反向地址解析协议）

![](https://i.loli.net/2020/04/22/uoIxTkhLE5S6j1i.png)

- 我们的主机很多时候都是将IP地址保存在配置文件中，无盘工作站没有硬盘，没办法将IP地址保存在配置文件当中，这个时候想获取无盘工作站的IP地址呢？
- 向RARP服务器发送一个请求，工作站知道自己的MAC地址，服务器事先将工作站的MAC地址和IP地址保存了起来，接收到请求之后将无盘工作站的IP地址响应回来。
- 这个流程称为反向地址解析协议