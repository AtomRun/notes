# 延迟消息队列是什么？

## 优惠券过期

coupon没有一个明确的过期标识，我们没有明显去修改，而是查询的时候带入了优惠券的有效期时间

在查询的SQL上加上了时间的限制

为什么没加上？

因为不好触发，没有一个主动的触发机制

## 订单改变状态

延迟支付，订单的支付有效期是在一个时间段内

订单需要一个明确的过期标识，即数据库中记录的status字段

我们在这里也可以查询的时候带上时间判断

但是我们这里有个库存的问题，即用户下单后扣除库存，但是用户下单并不代表是立即支付了，因为是延迟支付

这种方式其实是预扣除库存，有一个问题就是，用户有效期内没有付款，需要归还库存，stock需要加上扣除的数量

### 三个问题

即顺便将UnPaid->Cancel

1. 怎么去归还库存？
   1. 
2. 在什么时候归还库存？
   1. 订单到期的时候归还
3. 谁来触发归还库存的操作？

### 之前的触发方式

1. 主动轮询
   1. 如何保证在刚过完30分钟就正好触发？
   2. 每秒轮询真的精确吗？
   3. 浪费性能，例如每个定时器，每秒钟将数据库中到期的订单，都归还库存，需要扫描数据库，这样就很浪费性能。
   4. 也许是尝试一小时？十分钟轮询一次，但是造成误差很大，定时器不是很好的能解决问题
2. 被动触发
   1. 优惠券过期是用户触发，即用户使用的时候携带一个当前参数作比较

### 使用新方式

1. 队列
   1. 先进先出
2. 延迟消息队列
   1. 设置延迟一定的时间，将东西返回给我们
   2. 到时间把东西主动给我们
   3. 难得不是延迟，而是如何让队列主动将东西给我们

# Redis

redis安装之后想要外网访问其实是很危险的事

1. redis.conf中的bind 127.0.0.1注释掉
2. 配置保护模式为no
   1. CONFIG SET protected-mode no
   2. 使用CONFIG REWRITE使更改永久生效