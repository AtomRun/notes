# TCP/IP基础（四）

## TCP特点

- 基本于字节流
- 面向连接
- 可靠传输
- 缓冲传输
- 全双工
- 流量控制

![](https://i.loli.net/2020/04/27/VgJrnqL43ku8YBN.png)

## TCP报文格式

- 源端口号与目的端口号
  - 源端口号和目的端口号，加上IP首部的源IP地址和目的IP地址唯一确定一个TCP连接。
- 序号
  - 序号表示在这个报文段中的第一个数据字节序号。
- 确认号
  - 仅当ACK标志为1时有效。确认号表示期望收到的下一个字节的序号
- 头部长度
  - 4位，TCP头部最多60个字节
- 保留位
  - 6位，必须为0
- 6个标志位
  1. URG-紧急指针有效
  2. ACK-确认序号有效
  3. PSH一接收方应尽快将这个报文段交给应用层
  4. RST-连接重置
  5. SYN-同步序号用来发起一个连接
  6. FIN-表示将要终止一个连接
- 窗口大小
  - 通过窗口大小来达到流量控制。
- 校验和
  - 对tcp头与数捱进行校验。
- 紧急指针
  - 是一个正的偏移量，与序号字段中的值相加表示紧急数据最后一个字节的序号。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式。
- 选项与填充(选项为4字节整数倍，否则用0填充)
  - 最常见的可选字段是最长报文大公MSS ( Maximum Segment Size )，每个连接方通常都在通信的第一个报文段中指明这个选项。它指明本端所能接收的最大长度的报文段。该选项如果不设置，默认为536(20+ 20+536=576字节的IP数据报)

## 连接建立三次握手

![](https://i.loli.net/2020/04/27/Gudzq3Yyjg4TBIH.png)

## 连接终止四次握手

![](https://i.loli.net/2020/04/27/D6FAzuGeoCJ8q7M.png)

## TCP如何保证可靠性

1. 应用数据被分割成TCP认为最适合发送的数据块，称为段传递给IP层。
2. 当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个
   报文段。如果不能及时收到一个确认，将重发这个报文段。
3. 当TCP收到发自TCP连接另一端的数据，它将发送一一个确认。这个确认
   不是立即发送，通常将推迟几分之一秒。
4. TCP将保持它首部和数据的校验和。这是一个端到端的校验和，目的
   是检测数据在传输过程中的任何变化。如果收到段的校验和有差错，
   TCP将丢弃这个报文段并且不确认( 导致对方超时重传)
5. TCP承载于IP数据报来传输，而IP数据报的到达可能会失序，因此TCP
   报文段的到达也可能会失序。TCP将对收到的数据进行重新排序。
6. IP数据报会发生重复，TCP的接收端必须丢弃重复的数据。
7. TCP还能提供流量控制。TCP连接的每一方都有-定大小的缓冲空间。